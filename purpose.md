┌───────────────────────────────────────────────────────────────────────────┐
│     ccmm ── Claude Code 用プリセット管理 CLI の意義と解決課題         │
└───────────────────────────────────────────────────────────────────────────┘

■ Claude Code の前提仕様
  ● Claude Codeは、生成AIエージェントによるコーディングツール。Claudeが自律的にコード開発を行う。その挙動を決定するための指示/プロンプトファイルがCLAUDE.md。CLAUDE.mdは原則プロジェクトフォルダことに設定される。
  ● 作業ディレクトリ (cwd) からルート / までのすべての **CLAUDE.md / .local.md** を
    自動で再帰読み込みし、それらの内容を “メモリ” としてプロンプトに注入。
  ● `@path/to/file.md` で最大 5 階層まで追加ファイルをインポートできる。
  ● 読み込まれた行はすべてトークンを消費し、無関係なコメント・雑多な設定ファイル
    でも精度とレイテンシを下げる原因になる。

■ 従来の悩み
 1. **プリセットの再利用が面倒**  
    - React 用、Go 用、TypeScript 用…とプロジェクト横断で共有したいが  
      どこかの CLAUDE.md からコピペするしかなくバージョンが散逸。
 2. **自由に追記すると上流へ反映しづらい**  
    - 個々の開発者が「いいルール」を思いついて CLAUDE.md に直接書くと  
      共有リポジトリへ戻す手段と粒度が曖昧。
 3. **チーム再現性が無い／壊れやすい**  
    - 誰かがプリセットを更新すると、他メンバーの Claude だけ急に挙動が変わる。  
      CI ビルドも日によって落ちたり通ったり。
 4. **トークン肥大 & 誤読リスク**  
    - ロックファイルやガードコメントなど “人間向けメタ情報” が増えるほど  
      Claude が余計な行を読む＝品質が下がる。

■ ccmm が提供する解決
 1. **1 行インポートモデル**  
    - ルート `CLAUDE.md` に *たった 1 行*  
      `@~/.ccmm/projects/<slug>/merged-preset-<SHA>.md`  
      を自動挿入・管理。ユーザーの自由記述はその前に書ける。
 2. **HOME 側プリセットストア**  
    - 実体ファイルは `$HOME/.ccmm/presets/<host>/<owner>/<repo>/…`  
      ⇒ Claude の自動探索対象外なのでメモリ汚染ゼロ。  
    - 複数 CLAUDE-md リポの同名ファイルもネームスペースで衝突しない。
 3. **行ベース昇格フロー (`extract → edit → push`)**  
    - 作業中に追記した行を CLI でプリセットへ振り分け → GitHub PR を自動生成。  
      アイデア共有とコードレビューがワンフロー。
 4. **SHA 埋め込みロック**  
    - `merged-preset-<SHA>.md` という **ファイル名に commit を焼き込む** だけで  
      “どのバージョンを読むか” を厳密固定。追加ロックファイル不要。  
    - `ccmm lock/unlock` で HEAD 追従と再現ロックを瞬時に切替え。
 5. **軽量シンク (`sync`)**  
    - HEAD でもロック SHA でも必要ファイルだけ shallow-fetch → HOME キャッシュ。  
      リポジトリに巨大な vendor ディレクトリを抱え込まない。
 6. **衝突時の最小ダメージ**  
    - ロックは 1 行書き換え、プリセット更新もファイル単位。  
      Git コンフリクトはほぼ “1 行” もしくは “1 ファイル” に収束する。

■ 期待できる効果
 ① **プロジェクト間で設定再利用が容易**  
 ② **Prompt のバージョンが履歴に残り、バグ再現・監査が確実**  
 ③ **Claude のコンテキストが常にクリーン → 回答品質・速度が安定**  
 ④ **個人・小チームから大規模 CI まで同一ワークフローでスケール**  
 ⑤ **TypeScript + simple-git + GitHub CLI だけで実装が完結しやすい**

👉 つまり *ccmm* は  
「**Claude Code の“メモリ”を Git らしい運用フローに落とし込む橋渡しツール**」  
という位置づけ。初心者でも “sync → edit → push → lock” の４操作で  
プリセット管理・共有・再現を一気に自動化できる。 
